<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>OSM Intelligence - Montana Trails</title>
    <script src="https://unpkg.com/maplibre-gl@4.1.2/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl@4.1.2/dist/maplibre-gl.css" rel="stylesheet" />
    <script src="https://unpkg.com/pmtiles@3.0.6/dist/pmtiles.js"></script>
    <style>
      * { margin: 0; padding: 0; box-sizing: border-box; }
      body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; }
      #map { position: absolute; top: 0; bottom: 0; width: 100%; }

      .map-overlay {
        position: absolute; top: 10px; left: 10px; z-index: 1;
        background: rgba(15, 23, 42, 0.88);
        backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
        padding: 12px 16px; border-radius: 10px;
        font-size: 13px; color: #e2e8f0;
        border: 1px solid rgba(255,255,255,0.1);
        box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        max-width: 220px;
      }
      .map-overlay h3 { margin: 0 0 4px; font-size: 15px; color: #fff; }
      .map-overlay p { margin: 0; opacity: 0.7; font-size: 12px; }
      .trail-type-legend { margin-top: 8px; display: flex; flex-wrap: wrap; gap: 6px; }
      .legend-item { display: flex; align-items: center; gap: 4px; font-size: 11px; opacity: 0.8; }
      .legend-swatch { width: 16px; height: 3px; border-radius: 2px; }

      .bottom-bar {
        position: absolute; bottom: 24px; left: 10px; right: 10px; z-index: 1;
        display: flex; align-items: flex-end; justify-content: space-between;
        pointer-events: none;
      }
      .bottom-bar > * { pointer-events: auto; }

      .style-switcher { display: flex; gap: 6px; flex-wrap: wrap; }
      .style-btn {
        width: 56px; height: 56px; border-radius: 8px; border: 2px solid rgba(255,255,255,0.15);
        background-size: cover; background-position: center; cursor: pointer;
        position: relative; overflow: hidden; transition: border-color 0.2s, transform 0.15s;
        box-shadow: 0 2px 10px rgba(0,0,0,0.4);
      }
      .style-btn:hover { transform: scale(1.05); border-color: rgba(255,255,255,0.4); }
      .style-btn.active { border-color: #60a5fa; box-shadow: 0 0 0 1px #60a5fa, 0 2px 10px rgba(0,0,0,0.4); }
      .style-btn span {
        position: absolute; bottom: 0; left: 0; right: 0;
        background: rgba(0,0,0,0.7); color: #fff; font-size: 9px;
        text-align: center; padding: 2px 0; font-weight: 600;
      }

      .terrain-toggle {
        background: rgba(15,23,42,0.88); backdrop-filter: blur(12px);
        border: 1px solid rgba(255,255,255,0.1); border-radius: 8px;
        color: #e2e8f0; padding: 8px 14px; font-size: 13px; cursor: pointer;
        font-family: inherit; transition: background 0.2s;
        box-shadow: 0 2px 10px rgba(0,0,0,0.3); white-space: nowrap;
      }
      .terrain-toggle:hover { background: rgba(30,41,59,0.95); }
      .terrain-toggle.active { background: rgba(37,99,235,0.6); border-color: #60a5fa; }

      .maplibregl-popup-content {
        background: rgba(15,23,42,0.92) !important;
        backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
        border: 1px solid rgba(255,255,255,0.1) !important;
        border-radius: 10px !important; padding: 12px !important;
        box-shadow: 0 4px 20px rgba(0,0,0,0.4) !important; color: #e2e8f0;
      }
      .maplibregl-popup-tip { border-top-color: rgba(15,23,42,0.92) !important; }
      .maplibregl-popup-close-button { color: #94a3b8 !important; font-size: 18px !important; }

      @media (max-width: 480px) {
        .map-overlay { max-width: 180px; padding: 8px 12px; font-size: 12px; }
        .map-overlay h3 { font-size: 13px; }
        .style-btn { width: 48px; height: 48px; }
        .bottom-bar { bottom: 16px; left: 8px; right: 8px; }
      }
    </style>
  </head>
  <body>
    <div id="map"></div>

    <div class="map-overlay">
      <h3>üèîÔ∏è Montana Trails</h3>
      <p>OSM recreational trails ¬∑ PMTiles</p>
      <div class="trail-type-legend">
        <div class="legend-item"><div class="legend-swatch" style="background:#22d3ee"></div>path</div>
        <div class="legend-item"><div class="legend-swatch" style="background:#a78bfa"></div>track</div>
        <div class="legend-item"><div class="legend-swatch" style="background:#f472b6"></div>cycleway</div>
        <div class="legend-item"><div class="legend-swatch" style="background:#34d399"></div>footway</div>
        <div class="legend-item"><div class="legend-swatch" style="background:#fbbf24"></div>bridleway</div>
      </div>
    </div>

    <div class="bottom-bar">
      <div class="style-switcher" id="styleSwitcher"></div>
      <button class="terrain-toggle" id="terrainBtn" title="Toggle 3D terrain">‚õ∞Ô∏è 3D</button>
    </div>

    <script>
      // ‚îÄ‚îÄ Config ‚îÄ‚îÄ
      const protocol = new pmtiles.Protocol();
      maplibregl.addProtocol("pmtiles", protocol.tile);

      const base = window.location.href.replace(/\/[^/]*(\?.*)?$/, "/");
      const PMTILES_URL = base + "montana-trails.pmtiles";

      // ‚îÄ‚îÄ Styles (all free, no API keys) ‚îÄ‚îÄ
      function makeStyle(tiles, tileSize, maxzoom, attribution) {
        return {
          version: 8,
          glyphs: "https://demotiles.maplibre.org/font/{fontstack}/{range}.pbf",
          sources: { base: { type: "raster", tiles, tileSize: tileSize || 256, maxzoom: maxzoom || 20, attribution } },
          layers: [{ id: "base", type: "raster", source: "base" }],
        };
      }

      const ATTR_CARTO = '¬© <a href="https://www.openstreetmap.org/copyright">OSM</a> ¬© <a href="https://carto.com/">CARTO</a>';

      const STYLES = {
        dark: {
          name: "Dark",
          preview: "https://basemaps.cartocdn.com/dark_all/6/16/22@2x.png",
          style: makeStyle(["https://basemaps.cartocdn.com/dark_all/{z}/{x}/{y}@2x.png"], 256, 20, ATTR_CARTO),
        },
        topo: {
          name: "Topo",
          preview: "https://tile.opentopomap.org/6/16/22.png",
          style: makeStyle(["https://tile.opentopomap.org/{z}/{x}/{y}.png"], 256, 17, '¬© <a href="https://opentopomap.org">OpenTopoMap</a>'),
          trailColors: { path: "#0e7490", track: "#6d28d9", cycleway: "#be185d", footway: "#047857", bridleway: "#b45309", default: "#1d4ed8" },
          labelColors: { text: "#1e293b", halo: "rgba(255,255,255,0.9)" },
        },
        satellite: {
          name: "Satellite",
          preview: "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/6/22/16",
          style: makeStyle(["https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}"], 256, 19, '¬© <a href="https://www.esri.com">Esri</a>'),
          trailColors: { path: "#67e8f9", track: "#c4b5fd", cycleway: "#f9a8d4", footway: "#6ee7b7", bridleway: "#fcd34d", default: "#93c5fd" },
          labelColors: { text: "#ffffff", halo: "rgba(0,0,0,0.8)" },
        },
        light: {
          name: "Light",
          preview: "https://basemaps.cartocdn.com/light_all/6/16/22@2x.png",
          style: makeStyle(["https://basemaps.cartocdn.com/light_all/{z}/{x}/{y}@2x.png"], 256, 20, ATTR_CARTO),
          trailColors: { path: "#0891b2", track: "#7c3aed", cycleway: "#db2777", footway: "#059669", bridleway: "#d97706", default: "#2563eb" },
          labelColors: { text: "#1e293b", halo: "rgba(255,255,255,0.9)" },
        },
      };

      let currentStyleKey = "dark";
      let terrainEnabled = false;

      // ‚îÄ‚îÄ Trail colors ‚îÄ‚îÄ
      function getTypeColors(key) {
        const c = STYLES[key]?.trailColors;
        if (!c) return ["match",["get","highway"],"path","#22d3ee","track","#a78bfa","cycleway","#f472b6","footway","#34d399","bridleway","#fbbf24","#60a5fa"];
        return ["match",["get","highway"],"path",c.path,"track",c.track,"cycleway",c.cycleway,"footway",c.footway,"bridleway",c.bridleway,c.default];
      }
      function getLabelColors(key) {
        return STYLES[key]?.labelColors || { text: "#e2e8f0", halo: "rgba(15,23,42,0.9)" };
      }

      // ‚îÄ‚îÄ Add trail + terrain layers (called after every style change) ‚îÄ‚îÄ
      function addOverlays() {
        const tc = getTypeColors(currentStyleKey);
        const lc = getLabelColors(currentStyleKey);

        // PMTiles trails
        map.addSource("trails", { type: "vector", url: "pmtiles://" + PMTILES_URL });

        map.addLayer({
          id: "trails-layer", type: "line", source: "trails", "source-layer": "trails",
          layout: { "line-join": "round", "line-cap": "round" },
          paint: {
            "line-color": tc,
            "line-width": ["interpolate",["linear"],["zoom"],7,0.5,12,1.5,17,3],
            "line-opacity": ["interpolate",["linear"],["zoom"],7,0.4,12,0.85],
          },
        });

        map.addLayer({
          id: "trails-labels", type: "symbol", source: "trails", "source-layer": "trails",
          minzoom: 12,
          layout: {
            "text-field": ["get","name"],
            "text-font": ["Open Sans Bold"],
            "text-size": ["interpolate",["linear"],["zoom"],12,10,17,14],
            "symbol-placement": "line",
            "text-allow-overlap": false,
          },
          paint: { "text-color": lc.text, "text-halo-color": lc.halo, "text-halo-width": 2 },
        });

        // Re-apply terrain if enabled
        if (terrainEnabled) {
          addTerrainSource();
          map.setTerrain({ source: "terrain-dem", exaggeration: 1.5 });
        }
      }

      // ‚îÄ‚îÄ Terrain ‚îÄ‚îÄ
      function addTerrainSource() {
        if (map.getSource("terrain-dem")) return;
        map.addSource("terrain-dem", {
          type: "raster-dem",
          tiles: ["https://s3.amazonaws.com/elevation-tiles-prod/terrarium/{z}/{x}/{y}.png"],
          tileSize: 256,
          maxzoom: 15,
          encoding: "terrarium",
        });
      }

      function toggleTerrain() {
        terrainEnabled = !terrainEnabled;
        document.getElementById("terrainBtn").classList.toggle("active", terrainEnabled);
        if (terrainEnabled) {
          addTerrainSource();
          map.setTerrain({ source: "terrain-dem", exaggeration: 1.5 });
          map.easeTo({ pitch: 60, duration: 800 });
        } else {
          map.setTerrain(null);
          map.easeTo({ pitch: 0, duration: 800 });
        }
      }

      // ‚îÄ‚îÄ Style Switching ‚îÄ‚îÄ
      function switchStyle(key) {
        if (key === currentStyleKey) return;
        currentStyleKey = key;
        const center = map.getCenter();
        const zoom = map.getZoom();
        const pitch = map.getPitch();
        const bearing = map.getBearing();

        // setStyle wipes ALL sources and layers ‚Äî must re-add everything
        map.setStyle(STYLES[key].style);
        map.once("style.load", () => {
          map.jumpTo({ center, zoom, pitch, bearing });
          addOverlays();
        });

        document.querySelectorAll(".style-btn").forEach(b =>
          b.classList.toggle("active", b.dataset.style === key));
      }

      // ‚îÄ‚îÄ Build UI ‚îÄ‚îÄ
      const switcher = document.getElementById("styleSwitcher");
      Object.entries(STYLES).forEach(([key, cfg]) => {
        const btn = document.createElement("div");
        btn.className = "style-btn" + (key === currentStyleKey ? " active" : "");
        btn.dataset.style = key;
        btn.style.backgroundImage = `url(${cfg.preview})`;
        btn.innerHTML = `<span>${cfg.name}</span>`;
        btn.addEventListener("click", () => switchStyle(key));
        switcher.appendChild(btn);
      });
      document.getElementById("terrainBtn").addEventListener("click", toggleTerrain);

      // ‚îÄ‚îÄ Init Map ‚îÄ‚îÄ
      const map = new maplibregl.Map({
        container: "map",
        style: STYLES.dark.style,
        center: [-110.5, 46.8],
        zoom: 7,
        maxPitch: 85,
      });

      map.on("load", function () {
        map.addControl(new maplibregl.NavigationControl({ visualizePitch: true }), "top-right");
        map.addControl(new maplibregl.GeolocateControl({
          positionOptions: { enableHighAccuracy: true },
          trackUserLocation: true, showUserHeading: true,
        }), "top-right");
        map.addControl(new maplibregl.ScaleControl({ maxWidth: 80, unit: "imperial" }), "bottom-left");
        map.addControl(new maplibregl.FullscreenControl(), "top-right");

        addOverlays();

        map.on("click", "trails-layer", function (e) {
          const p = e.features[0].properties;
          new maplibregl.Popup({ maxWidth: "260px" })
            .setLngLat(e.lngLat)
            .setHTML(
              `<strong style="font-size:14px">${p.name || "Unnamed Trail"}</strong>
              <div style="margin-top:6px;font-size:12px;opacity:0.8">
                ${p.highway ? `<div>Type: ${p.highway}</div>` : ""}
                ${p.surface ? `<div>Surface: ${p.surface}</div>` : ""}
                ${p.route ? `<div>Route: ${p.route}</div>` : ""}
              </div>`
            )
            .addTo(map);
        });
        map.on("mouseenter", "trails-layer", () => { map.getCanvas().style.cursor = "pointer"; });
        map.on("mouseleave", "trails-layer", () => { map.getCanvas().style.cursor = ""; });
      });
    </script>
  </body>
</html>
